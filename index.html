<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Tool - Professional Player Auction Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 40px 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, #a8dadc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .header-logo {
            font-size: 3.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            padding: 0 20px;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            color: #64748b;
            position: relative;
        }

        .tab:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .tab.active {
            color: #0f3460;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 400px;
            height: auto;
            width: 100%;
            position: relative;
            background: white;
        }

        .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #0f3460;
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .team-card {
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: #0f3460;
        }

        .team-card h3 {
            color: #0f3460;
            margin-bottom: 16px;
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .team-logo-large {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid #0f3460;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .team-logo-presentation {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            object-fit: cover;
            border: 4px solid #0f3460;
            box-shadow: 0 8px 20px rgba(15, 52, 96, 0.4);
            margin-bottom: 20px;
        }

        .team-placeholder-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            border: 2px solid #e2e8f0;
        }

        .team-info {
            margin: 8px 0;
            color: #475569;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-info strong {
            color: #1e293b;
        }

        .players-list {
            margin-top: 20px;
        }

        .player-item {
            background: white;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 4px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s;
        }

        .player-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .player-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0f3460;
            margin-right: 15px;
        }

        .player-image-large {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 6px solid #0f3460;
            margin: 20px auto;
            display: block;
            box-shadow: 0 8px 24px rgba(15, 52, 96, 0.3);
        }

        .player-info-wrapper {
            display: flex;
            align-items: center;
        }

        .player-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 22px;
            margin-right: 15px;
            box-shadow: 0 2px 8px rgba(15, 52, 96, 0.3);
        }

        .player-placeholder-large {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 64px;
            margin: 20px auto;
            box-shadow: 0 8px 24px rgba(15, 52, 96, 0.4);
        }

        .auction-area {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .current-player {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            border: 2px solid #e2e8f0;
        }

        .current-player h2 {
            color: #0f3460;
            font-size: 2.4em;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .player-details {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 24px 0;
            font-size: 17px;
            color: #475569;
        }

        .bid-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin: 24px 0;
        }

        .current-bid {
            font-size: 3em;
            color: #10b981;
            font-weight: 800;
            margin: 24px 0;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        .team-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 24px 0;
        }

        .team-btn {
            padding: 12px 24px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
            color: #475569;
        }

        .team-btn:hover {
            background: #f8fafc;
            border-color: #0f3460;
            color: #0f3460;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .team-btn.selected {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            color: white;
            border-color: #0f3460;
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 28px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            border-color: #0f3460;
        }

        .stat-value {
            font-size: 2.8em;
            color: #0f3460;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #64748b;
            margin-top: 5px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .sold-players {
            margin-top: 30px;
        }

        .sold-player {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid;
            font-size: 15px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .import-export {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .sold-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .sold-overlay.show {
            display: flex;
        }

        .sold-content {
            text-align: center;
            animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .sold-text {
            font-size: 10em;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 40px rgba(239, 68, 68, 0.8), 0 0 80px rgba(239, 68, 68, 0.6);
            margin-bottom: 20px;
            animation: pulse 0.5s ease-in-out 3;
        }

        .sold-details {
            font-size: 2.5em;
            color: #fbbf24;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .hammer-icon {
            font-size: 8em;
            margin-bottom: 20px;
            animation: hammer 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes hammer {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-30deg);
            }
            50% {
                transform: rotate(0deg);
            }
            75% {
                transform: rotate(-30deg);
            }
        }

        .dashboard-team-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .dashboard-team-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .dashboard-team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .dashboard-team-name {
            font-size: 1.8em;
            font-weight: 700;
            color: #0f3460;
        }

        .dashboard-purse {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .dashboard-purse-item {
            text-align: center;
        }

        .dashboard-purse-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .dashboard-purse-value {
            font-size: 1.8em;
            font-weight: 800;
        }

        .dashboard-purse-remaining {
            color: #10b981;
        }

        .dashboard-purse-spent {
            color: #ef4444;
        }

        .dashboard-squad-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .dashboard-info-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .dashboard-info-badge.complete {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }

        .dashboard-info-badge.incomplete {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .dashboard-info-badge.full {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        .dashboard-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .dashboard-player-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .dashboard-player-card:hover {
            border-color: #0f3460;
            transform: translateX(4px);
        }

        .dashboard-player-info {
            flex: 1;
        }

        .dashboard-player-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .dashboard-player-type {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .dashboard-player-price {
            font-weight: 700;
            color: #10b981;
            font-size: 14px;
            white-space: nowrap;
        }

        .dashboard-empty-state {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-style: italic;
        }

        @media print {
            .tabs, .btn, .header {
                display: none !important;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                max-width: 100%;
            }

            /* BROADCASTING THEME FOR DASHBOARD & TEAMS */
            #dashboard, #teams {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important;
                color: white;
                border-radius: 0 0 20px 20px;
                box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            }
            
            #dashboard h2, #dashboard h3, #dashboard p,
            #teams h3, #teams p {
                color: white !important;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
                opacity: 1 !important;
            }

            #teams .team-card, #dashboard .dashboard-team-card {
                background: rgba(255, 255, 255, 0.95);
                box-shadow: 0 10px 30px rgba(0,0,0,0.4);
                border: none;
                backdrop-filter: blur(10px);
            }

            #teams .team-card h3,
            #dashboard .dashboard-team-name,
            #dashboard .dashboard-player-name {
                color: #0f3460 !important;
                text-shadow: none !important;
            }

            #dashboard .dashboard-empty-state, 
            #teams .dashboard-empty-state {
                color: rgba(255,255,255,0.7);
            }
            
            .dashboard-team-card {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        /* Presentation Mode Styles */
        .presentation-mode {
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 40px;
        }

        .presentation-header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            margin-bottom: 40px;
            border: 3px solid #0f3460;
        }

        .presentation-title {
            font-size: 4em;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 4px 12px rgba(255,255,255,0.3);
        }

        .presentation-subtitle {
            font-size: 2em;
            color: #a8dadc;
            font-weight: 300;
        }

        .presentation-current-player {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 30px;
            padding: 60px;
            margin-bottom: 40px;
            border: 4px solid #0f3460;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .presentation-player-image {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            object-fit: cover;
            border: 8px solid #0f3460;
            margin: 0 auto 40px;
            display: block;
            box-shadow: 0 12px 40px rgba(15, 52, 96, 0.6);
        }

        .presentation-player-placeholder {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 120px;
            margin: 0 auto 40px;
            box-shadow: 0 12px 40px rgba(15, 52, 96, 0.8);
        }

        .presentation-player-name {
            font-size: 5em;
            font-weight: 900;
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 4px 20px rgba(255,255,255,0.4);
        }

        .presentation-player-details {
            display: flex;
            justify-content: center;
            gap: 80px;
            font-size: 2.5em;
            margin: 40px 0;
            font-weight: 600;
        }

        .presentation-player-details > div {
            padding: 20px 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .presentation-current-bid {
            font-size: 6em;
            color: #10b981;
            font-weight: 900;
            text-align: center;
            margin: 50px 0;
            text-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
            animation: pulse 2s ease-in-out infinite;
        }

        .presentation-timer {
            font-size: 5em;
            font-weight: 900;
            text-align: center;
            margin: 40px 0;
            font-family: monospace;
        }

        .presentation-teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .presentation-team-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #475569;
            transition: all 0.3s;
        }

        .presentation-team-card.highlight {
            border-color: #10b981;
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.5);
            transform: scale(1.05);
        }

        .presentation-team-name {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 20px;
            color: #fff;
        }

        .presentation-team-budget {
            font-size: 3em;
            color: #10b981;
            font-weight: 900;
            margin: 15px 0;
        }

        .presentation-team-info {
            font-size: 1.8em;
            margin: 10px 0;
            color: #cbd5e1;
        }

        .presentation-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 40px;
            border-radius: 50px;
            border: 2px solid #0f3460;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .presentation-btn {
            padding: 15px 35px;
            font-size: 1.3em;
            border: none;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .presentation-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-logo">üèÜ</div>
                <h1>Auction Tool</h1>
                <p>Professional Player Auction Management System</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('setup')">‚öôÔ∏è Setup</button>
            <button class="tab" onclick="switchTab('auction')">üî® Auction</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('presentation')">üìΩÔ∏è Presentation</button>
            <button class="tab" onclick="switchTab('teams')">üë• Teams</button>
            <button class="tab" onclick="switchTab('players')">üèÉ Players</button>
        </div>

        <!-- Setup Tab -->
        <div id="setup" class="tab-content active">
            <h2>Setup Your Auction</h2>
            
            <div class="form-group">
                <label>üîä Audio System Test</label>
                <div style="background: #e0f2fe; padding: 20px; border-radius: 12px; margin-top: 10px; border: 2px solid #0284c7;">
                    <p style="margin-bottom: 15px; color: #0c4a6e;"><strong>Test your audio before starting the auction!</strong></p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="testHammerSound()">üî® Test Hammer Sound</button>
                        <button class="btn btn-warning" onclick="testTimerAlert()">‚è∞ Test Timer Alert</button>
                        <button class="btn btn-success" onclick="testVoiceAnnouncement()">üó£Ô∏è Test Voice</button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #0284c7;">
                        <small style="color: #0c4a6e;">
                            <strong>üí° Best Practice:</strong> Click all three test buttons before starting your auction to ensure speakers are working properly. 
                            This also initializes the audio system in your browser.
                        </small>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>üíæ Data Backup & Safety</label>
                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; margin-top: 10px; border: 2px solid #f59e0b;">
                    <div style="margin-bottom: 15px;">
                        <p style="color: #92400e; font-weight: 600; margin-bottom: 10px;">
                            ‚ö†Ô∏è CRITICAL: Always backup your data before starting the live auction!
                        </p>
                        <p style="color: #92400e; font-size: 14px; margin-bottom: 15px;">
                            Browser data can be lost if cookies are cleared or the browser crashes. 
                            Export your setup now to ensure you can recover if anything goes wrong.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="exportData()">üì• Backup Now (JSON)</button>
                        <button class="btn btn-success" onclick="exportTeamsToExcel()">üìä Backup Now (Excel)</button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <small style="color: #92400e;">
                            <strong>‚úì Best Practice:</strong> 
                            <ul style="margin: 5px 0 0 20px; padding: 0;">
                                <li>Export before auction starts</li>
                                <li>Export after auction completes</li>
                                <li>Keep backup files in a safe location</li>
                                <li>Never rely on browser storage alone</li>
                            </ul>
                        </small>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">
            
            <div class="form-group">
                <label>Add Team</label>
                <input type="text" id="teamName" placeholder="Enter team name">
                <input type="number" id="teamBudget" placeholder="Team budget (in lakhs)" style="margin-top: 10px;">
                <div style="margin-top: 10px;">
                    <label style="font-size: 14px;">Team Logo (optional):</label>
                    <input type="file" id="teamLogo" accept="image/*" style="margin-top: 5px;">
                    <div style="margin-top: 5px; padding: 8px; background: #e0f2fe; border-radius: 6px; border-left: 3px solid #0284c7;">
                        <small style="color: #0c4a6e;"><strong>üí° Tip:</strong> Use small, compressed JPG images (max 300x300px, under 100KB) to avoid storage issues.</small>
                    </div>
                    <div id="teamLogoPreview" style="margin-top: 10px; display: none;">
                        <img id="teamLogoPreviewImg" style="max-width: 100px; max-height: 100px; border-radius: 10px; border: 2px solid #ddd;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTeam()" style="margin-top: 10px;">Add Team</button>
            </div>

            <div class="teams-grid" id="teamsList"></div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>üîß Diagnostic Tools</label>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 10px; border: 2px solid #ffc107;">
                    <p style="margin-bottom: 15px; color: #856404;"><strong>Troubleshooting:</strong> If tabs are not showing data after import, click this button:</p>
                    <button class="btn btn-warning" onclick="forceRefreshAllTabs()" style="width: 100%;">
                        üîÑ Force Refresh All Tabs
                    </button>
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 12px; color: #666;">
                        This will update: Setup, Teams, Players, Dashboard, and Presentation tabs
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>‚è±Ô∏è Auction Timer Settings</label>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                        <input type="checkbox" id="timerEnabled" onchange="toggleTimerSettings()" style="width: auto; margin-right: 10px;">
                        <span>Enable Timer for Each Player</span>
                    </label>
                    
                    <div id="timerSettings" style="display: none;">
                        <label style="font-size: 14px; margin-bottom: 5px;">Timer Duration:</label>
                        <select id="timerDuration" style="margin-top: 5px;">
                            <option value="30">30 Seconds</option>
                            <option value="60">1 Minute</option>
                            <option value="90" selected>1 Minute 30 Seconds</option>
                            <option value="120">2 Minutes</option>
                            <option value="150">2 Minutes 30 Seconds</option>
                            <option value="180">3 Minutes</option>
                            <option value="240">4 Minutes</option>
                            <option value="300">5 Minutes</option>
                        </select>
                        
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                            <small><strong>üí° How it works:</strong> Timer starts when each player appears. You can pause/resume anytime. Timer alerts you when time is up!</small>
                        </div>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>üë• Squad Size Limits</label>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 10px; border: 2px solid #e2e8f0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="font-size: 14px; margin-bottom: 8px; display: block; color: #475569;">Minimum Squad Size:</label>
                            <select id="minSquadSize" onchange="updateSquadLimits()" style="margin-top: 5px;">
                                <option value="9">9 Players</option>
                                <option value="10">10 Players</option>
                                <option value="11" selected>11 Players</option>
                                <option value="12">12 Players</option>
                                <option value="13">13 Players</option>
                                <option value="14">14 Players</option>
                                <option value="15">15 Players</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 14px; margin-bottom: 8px; display: block; color: #475569;">Maximum Squad Size:</label>
                            <select id="maxSquadSize" onchange="updateSquadLimits()" style="margin-top: 5px;">
                                <option value="9">9 Players</option>
                                <option value="10">10 Players</option>
                                <option value="11">11 Players</option>
                                <option value="12">12 Players</option>
                                <option value="13">13 Players</option>
                                <option value="14">14 Players</option>
                                <option value="15" selected>15 Players</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="squadLimitInfo" style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #0f3460;">
                        <small><strong>üìã Current Settings:</strong> Teams must have between <span id="minDisplay">11</span> and <span id="maxDisplay">15</span> players</small>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <small><strong>‚ö†Ô∏è Note:</strong> Squad limits are enforced during auction. You cannot sell a player if the team has reached maximum capacity.</small>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>üé≤ Auction Sets Configuration</label>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 10px; border: 2px solid #e2e8f0;">
                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                        <input type="checkbox" id="setsEnabled" onchange="toggleSetsConfiguration()" style="width: auto; margin-right: 10px;">
                        <span>Enable Set-Based Auction (Players grouped by category)</span>
                    </label>
                    
                    <div id="setsConfiguration" style="display: none;">
                        <div style="margin-bottom: 15px; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7;">
                            <small><strong>üí° How it works:</strong> Players will be randomly drawn from each set in order. You can customize which player types go into each set.</small>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                <label style="font-size: 14px; font-weight: 700; color: #0f3460; margin-bottom: 10px; display: block;">üì¶ Set 1</label>
                                <select id="set1Type" style="margin-bottom: 10px;">
                                    <option value="Batsman" selected>Batsman</option>
                                    <option value="Bowler">Bowler</option>
                                    <option value="All-Rounder">All-Rounder</option>
                                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                                    <option value="All">All Types (Mixed)</option>
                                </select>
                                <div style="font-size: 12px; color: #64748b;">Players of this type will be drawn first</div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                <label style="font-size: 14px; font-weight: 700; color: #0f3460; margin-bottom: 10px; display: block;">üì¶ Set 2</label>
                                <select id="set2Type" style="margin-bottom: 10px;">
                                    <option value="Batsman">Batsman</option>
                                    <option value="Bowler" selected>Bowler</option>
                                    <option value="All-Rounder">All-Rounder</option>
                                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                                    <option value="All">All Types (Mixed)</option>
                                </select>
                                <div style="font-size: 12px; color: #64748b;">Players of this type will be drawn second</div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                <label style="font-size: 14px; font-weight: 700; color: #0f3460; margin-bottom: 10px; display: block;">üì¶ Set 3</label>
                                <select id="set3Type" style="margin-bottom: 10px;">
                                    <option value="Batsman">Batsman</option>
                                    <option value="Bowler">Bowler</option>
                                    <option value="All-Rounder" selected>All-Rounder</option>
                                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                                    <option value="All">All Types (Mixed)</option>
                                </select>
                                <div style="font-size: 12px; color: #64748b;">Players of this type will be drawn third</div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0;">
                                <label style="font-size: 14px; font-weight: 700; color: #0f3460; margin-bottom: 10px; display: block;">üì¶ Set 4</label>
                                <select id="set4Type" style="margin-bottom: 10px;">
                                    <option value="Batsman">Batsman</option>
                                    <option value="Bowler">Bowler</option>
                                    <option value="All-Rounder">All-Rounder</option>
                                    <option value="Wicket-Keeper" selected>Wicket-Keeper</option>
                                    <option value="All">All Types (Mixed)</option>
                                </select>
                                <div style="font-size: 12px; color: #64748b;">Players of this type will be drawn fourth</div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <small><strong>‚ö†Ô∏è Important:</strong> When auction starts, players will be randomly shuffled within each set. The auction will go through Set 1, then Set 2, then Set 3, then Set 4. Any remaining players will come after all sets are complete.</small>
                        </div>

                        <button class="btn btn-primary" onclick="previewSetDistribution()" style="margin-top: 15px; width: 100%;">
                            üëÅÔ∏è Preview Set Distribution
                        </button>
                    </div>
                </div>
            </div>

            <hr style="margin: 30px 0;">

            <div class="form-group">
                <label>Add Player</label>
                <input type="text" id="playerName" placeholder="Player name">
                <select id="playerType" style="margin-top: 10px;">
                    <option value="Batsman">Batsman</option>
                    <option value="Bowler">Bowler</option>
                    <option value="All-Rounder">All-Rounder</option>
                    <option value="Wicket-Keeper">Wicket-Keeper</option>
                </select>
                <input type="number" id="basePrice" placeholder="Base price (in lakhs)" style="margin-top: 10px;">
                <div style="margin-top: 10px;">
                    <label style="font-size: 14px;">Player Photo (optional):</label>
                    <input type="file" id="playerImage" accept="image/*" style="margin-top: 5px;">
                    <div style="margin-top: 5px; padding: 8px; background: #e0f2fe; border-radius: 6px; border-left: 3px solid #0284c7;">
                        <small style="color: #0c4a6e;"><strong>üí° Tip:</strong> Use small, compressed JPG images (max 300x300px, under 100KB) to avoid storage issues.</small>
                    </div>
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 150px; max-height: 150px; border-radius: 10px; border: 2px solid #ddd;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addPlayer()" style="margin-top: 10px;">Add Player</button>
            </div>

            <div class="import-export">
                <button class="btn btn-warning" onclick="exportData()">üì• Export Data (JSON)</button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">üì§ Import Data (JSON)</button>
                <button class="btn btn-success" onclick="document.getElementById('excelFile').click()">üìä Import Excel File</button>
                <button class="btn btn-success" onclick="downloadExcelTemplate()">üìã Download Excel Template</button>
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
                <input type="file" id="excelFile" style="display: none;" accept=".xlsx,.xls" onchange="importExcel(event)">
            </div>
            
            <div class="alert alert-success" style="margin-top: 20px;">
                <strong>üí° Tip:</strong> Click "Download Excel Template" to get a ready-to-use Excel file. Fill it with your teams and players, then click "Import Excel File" to upload it!
            </div>
        </div>

        <!-- Auction Tab -->
        <div id="auction" class="tab-content">
            <div class="auction-area">
            <div class="auction-area">
                <div id="auctionMessage" class="alert alert-warning">
                    Click "Start Auction" to begin!
                </div>

                <div id="currentPlayerArea" style="display: none;">
                    <div class="current-player">
                        <div id="timerDisplay" style="display: none; margin-bottom: 20px;">
                            <div id="timerCircle" style="text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; color: #667eea; font-family: monospace;" id="timerText">1:30</div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-warning" onclick="pauseTimer()" id="pauseBtn">‚è∏Ô∏è Pause</button>
                                    <button class="btn btn-success" onclick="resumeTimer()" id="resumeBtn" style="display: none;">‚ñ∂Ô∏è Resume</button>
                                    <button class="btn btn-danger" onclick="resetTimer()" id="resetBtn">üîÑ Reset</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="currentPlayerImageContainer"></div>
                        <h2 id="currentPlayerName"></h2>
                        <div class="player-details">
                            <div><strong>Type:</strong> <span id="currentPlayerType"></span></div>
                            <div><strong>Base Price:</strong> ‚Çπ<span id="currentBasePrice"></span>L</div>
                        </div>
                        <div class="current-bid">
                            Current Bid: ‚Çπ<span id="currentBid">0</span>L
                        </div>
                        <div class="bid-controls">
                            <button class="btn btn-success" onclick="increaseBid(1)">+1L</button>
                            <button class="btn btn-success" onclick="increaseBid(5)">+5L</button>
                            <button class="btn btn-success" onclick="increaseBid(10)">+10L</button>
                            <button class="btn btn-success" onclick="increaseBid(25)">+25L</button>
                            <button class="btn btn-success" onclick="increaseBid(50)">+50L</button>
                        </div>
                        
                        <div style="margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.5); border-radius: 10px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #0f3460;">üí∞ Custom Bid Amount:</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <select id="customBidDropdown" onchange="handleCustomBidDropdown()" style="flex: 1; padding: 10px; font-size: 14px; border: 2px solid #cbd5e1; border-radius: 8px;">
                                    <option value="">-- Select Amount --</option>
                                    <option value="2">+2 Lakhs</option>
                                    <option value="3">+3 Lakhs</option>
                                    <option value="7">+7 Lakhs</option>
                                    <option value="15">+15 Lakhs</option>
                                    <option value="20">+20 Lakhs</option>
                                    <option value="30">+30 Lakhs</option>
                                    <option value="40">+40 Lakhs</option>
                                    <option value="75">+75 Lakhs</option>
                                    <option value="100">+100 Lakhs</option>
                                    <option value="custom">‚úèÔ∏è Enter Custom</option>
                                </select>
                                <button class="btn btn-primary" onclick="applyCustomBid()">Apply ‚úì</button>
                            </div>
                            
                            <div id="customBidInput" style="display: none;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="number" id="customBidValue" placeholder="Enter amount" min="0.1" step="0.1" style="flex: 1; padding: 10px; font-size: 14px; border: 2px solid #cbd5e1; border-radius: 8px;">
                                    <button class="btn btn-success" onclick="applyCustomBidValue()">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="team-selector" id="teamSelector"></div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="sellPlayer()">Sold!</button>
                            <button class="btn btn-danger" onclick="unsoldPlayer()">Unsold</button>
                            <button class="btn btn-warning" onclick="skipPlayer()">Skip</button>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="startAuction()" id="startBtn">Start Auction</button>
                <button class="btn btn-warning" onclick="nextPlayer()" id="nextBtn" style="display: none;">Next Player</button>
                <button class="btn btn-warning" onclick="pauseAuction()" id="pauseAuctionBtn" style="display: none;">‚è∏Ô∏è Pause Auction</button>
                <button class="btn btn-success" onclick="resumeAuction()" id="resumeAuctionBtn" style="display: none;">‚ñ∂Ô∏è Resume Auction</button>
                <button class="btn btn-danger" onclick="undoLastSale()" id="undoBtn" style="display: none;">‚èÆÔ∏è Undo Last Sale</button>
            </div>

            <div id="pausedMessage" class="alert alert-warning" style="display: none; margin-top: 20px;">
                <strong>‚è∏Ô∏è Auction Paused</strong> - Click "Resume Auction" to continue
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalPlayers">0</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="soldPlayers">0</div>
                    <div class="stat-label">Sold Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unsoldPlayers">0</div>
                    <div class="stat-label">Unsold Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="remainingPlayers">0</div>
                    <div class="stat-label">Remaining Players</div>
                </div>
            </div>

            <div class="sold-players">
                <h3>Recently Sold Players</h3>
                <div id="soldPlayersList"></div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #0f3460; font-size: 2em; margin: 0;">Live Auction Dashboard</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="exportTeamsToExcel()">üìä Export to Excel</button>
                    <button class="btn btn-warning" onclick="printSummaryReport()">üñ®Ô∏è Print Report</button>
                    <button class="btn btn-primary" onclick="updateDashboard()">üîÑ Refresh Dashboard</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="stats" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-value" id="dashTotalTeams">0</div>
                    <div class="stat-label">Total Teams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashTotalBudget">0</div>
                    <div class="stat-label">Total Budget (L)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashTotalSpent">0</div>
                    <div class="stat-label">Total Spent (L)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dashPlayersSold">0</div>
                    <div class="stat-label">Players Sold</div>
                </div>
            </div>

            <!-- Teams Dashboard -->
            <div id="teamsDashboard"></div>
        </div>

        <!-- Presentation Mode Tab -->
        <div id="presentation" class="tab-content">
            <div class="presentation-mode" id="presentationContent">
                <div class="presentation-header">
                    <div class="presentation-title">üèÜ LIVE AUCTION</div>
                    <div class="presentation-subtitle">Professional Player Auction System</div>
                </div>

                <div id="presentationCurrentPlayer" style="display: none;">
                    <div class="presentation-current-player">
                        <div id="presentationPlayerImage"></div>
                        <div class="presentation-player-name" id="presentationPlayerName"></div>
                        <div class="presentation-player-details">
                            <div><strong>Type:</strong> <span id="presentationPlayerType"></span></div>
                            <div><strong>Base Price:</strong> ‚Çπ<span id="presentationBasePrice"></span>L</div>
                        </div>
                        <div class="presentation-current-bid">
                            CURRENT BID: ‚Çπ<span id="presentationBid">0</span>L
                        </div>
                        <div id="presentationTimer" class="presentation-timer" style="display: none;"></div>
                    </div>
                </div>

                <div class="presentation-teams-grid" id="presentationTeams"></div>
            </div>

            <div class="presentation-controls">
                <button class="presentation-btn btn-success" onclick="presentationRefresh()">üîÑ Refresh</button>
                <button class="presentation-btn btn-primary" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="presentation-btn btn-warning" onclick="switchTab('auction')">‚Üê Back to Auction</button>
            </div>
        </div>

        <!-- Teams Tab -->
        <div id="teams" class="tab-content">
            <h2>Team Overview</h2>
            <div class="teams-grid" id="teamsOverview"></div>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content">
            <h2>All Players</h2>
            <div class="players-list" id="playersList"></div>
        </div>
    </div>

    <!-- Sold Overlay -->
    <div id="soldOverlay" class="sold-overlay">
        <div class="sold-content">
            <div class="hammer-icon">üî®</div>
            <div class="sold-text">SOLD!</div>
            <div class="sold-details" id="soldDetailsText"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let teams = [];
        let players = [];
        let currentPlayerIndex = -1;
        let auctionStarted = false;
        let selectedTeam = null;
        let currentBidAmount = 0;
        
        // Timer variables
        let timerEnabled = false;
        let timerDuration = 90; // default 90 seconds
        let timerInterval = null;
        let remainingTime = 0;
        let timerPaused = false;
        
        // Squad size variables
        let minSquadSize = 11;
        let maxSquadSize = 15;
        
        // Auction sets variables
        let setsEnabled = false;
        let auctionOrder = []; // Will hold the ordered list of player indices
        
        // Undo functionality
        let lastTransaction = null; // Store last sale for undo
        let auctionPaused = false;
        let buttonsLocked = false; // Prevent double-clicks during animations

        function toggleSetsConfiguration() {
            const enabled = document.getElementById('setsEnabled').checked;
            document.getElementById('setsConfiguration').style.display = enabled ? 'block' : 'none';
            setsEnabled = enabled;
            saveData();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function organizePlayersIntoSets() {
            const set1Type = document.getElementById('set1Type').value;
            const set2Type = document.getElementById('set2Type').value;
            const set3Type = document.getElementById('set3Type').value;
            const set4Type = document.getElementById('set4Type').value;

            // Get unsold players
            const unsoldPlayers = players.map((p, index) => ({player: p, index: index}))
                .filter(item => item.player.status === 'unsold');

            // Organize into sets
            const set1 = [];
            const set2 = [];
            const set3 = [];
            const set4 = [];
            const remaining = [];

            unsoldPlayers.forEach(item => {
                const type = item.player.type;
                let assigned = false;

                if ((set1Type === type || set1Type === 'All') && !assigned) {
                    set1.push(item.index);
                    assigned = true;
                } else if ((set2Type === type || set2Type === 'All') && !assigned) {
                    set2.push(item.index);
                    assigned = true;
                } else if ((set3Type === type || set3Type === 'All') && !assigned) {
                    set3.push(item.index);
                    assigned = true;
                } else if ((set4Type === type || set4Type === 'All') && !assigned) {
                    set4.push(item.index);
                    assigned = true;
                } else if (!assigned) {
                    remaining.push(item.index);
                }
            });

            // Shuffle each set randomly
            const shuffledSet1 = shuffleArray(set1);
            const shuffledSet2 = shuffleArray(set2);
            const shuffledSet3 = shuffleArray(set3);
            const shuffledSet4 = shuffleArray(set4);
            const shuffledRemaining = shuffleArray(remaining);

            // Combine all sets in order
            auctionOrder = [
                ...shuffledSet1,
                ...shuffledSet2,
                ...shuffledSet3,
                ...shuffledSet4,
                ...shuffledRemaining
            ];

            return {
                set1: shuffledSet1.length,
                set2: shuffledSet2.length,
                set3: shuffledSet3.length,
                set4: shuffledSet4.length,
                remaining: shuffledRemaining.length
            };
        }

        function previewSetDistribution() {
            if (players.length === 0) {
                alert('Please add players first!');
                return;
            }

            const set1Type = document.getElementById('set1Type').value;
            const set2Type = document.getElementById('set2Type').value;
            const set3Type = document.getElementById('set3Type').value;
            const set4Type = document.getElementById('set4Type').value;

            const distribution = organizePlayersIntoSets();

            const message = `üìä SET DISTRIBUTION PREVIEW\n\n` +
                `üì¶ Set 1 (${set1Type}): ${distribution.set1} players\n` +
                `üì¶ Set 2 (${set2Type}): ${distribution.set2} players\n` +
                `üì¶ Set 3 (${set3Type}): ${distribution.set3} players\n` +
                `üì¶ Set 4 (${set4Type}): ${distribution.set4} players\n` +
                `üì¶ Remaining: ${distribution.remaining} players\n\n` +
                `Total unsold players: ${distribution.set1 + distribution.set2 + distribution.set3 + distribution.set4 + distribution.remaining}\n\n` +
                `Players will be randomly shuffled within each set when auction starts.`;

            alert(message);
        }

        function undoLastSale() {
            if (!lastTransaction) {
                alert('No transaction to undo!');
                return;
            }
            
            if (!confirm(`‚èÆÔ∏è UNDO LAST SALE\n\nAre you sure you want to undo the sale of ${lastTransaction.player.name} to ${lastTransaction.player.soldTo} for ‚Çπ${lastTransaction.price}L?`)) {
                return;
            }
            
            // Restore player status
            const player = players[lastTransaction.playerIndex];
            player.status = 'unsold';
            player.soldTo = null;
            player.soldPrice = 0;
            
            // Restore team budget and remove player
            const team = teams[lastTransaction.teamIndex];
            team.remainingBudget = lastTransaction.teamRemainingBudget;
            team.players = team.players.filter(p => p.name !== player.name);
            
            // Remove from sold list (just refresh it)
            const soldList = document.getElementById('soldPlayersList');
            if (soldList.firstChild) {
                soldList.removeChild(soldList.firstChild);
            }
            
            updateStats();
            updateTeamsOverview();
            updateDashboard();
            updatePlayersList(); // Update players list after undo
            saveData();
            
            // Clear last transaction
            lastTransaction = null;
            document.getElementById('undoBtn').style.display = 'none';
            
            // Unlock buttons in case they were locked
            unlockActionButtons();
            
            alert('‚úÖ Last sale has been undone successfully!');
        }

        function pauseAuction() {
            auctionPaused = true;
            stopTimer();
            document.getElementById('pauseAuctionBtn').style.display = 'none';
            document.getElementById('resumeAuctionBtn').style.display = 'inline-block';
            document.getElementById('pausedMessage').style.display = 'block';
            document.getElementById('currentPlayerArea').style.opacity = '0.5';
        }

        function resumeAuction() {
            auctionPaused = false;
            startTimer();
            document.getElementById('pauseAuctionBtn').style.display = 'inline-block';
            document.getElementById('resumeAuctionBtn').style.display = 'none';
            document.getElementById('pausedMessage').style.display = 'none';
            document.getElementById('currentPlayerArea').style.opacity = '1';
        }

        function exportTeamsToExcel() {
            if (teams.length === 0) {
                alert('No teams to export!');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['AUCTION SUMMARY REPORT'],
                ['Generated on: ' + new Date().toLocaleString()],
                [''],
                ['Total Teams', teams.length],
                ['Total Players Sold', players.filter(p => p.status === 'sold').length],
                ['Total Budget', teams.reduce((sum, t) => sum + t.budget, 0) + 'L'],
                ['Total Spent', teams.reduce((sum, t) => sum + (t.budget - t.remainingBudget), 0).toFixed(2) + 'L'],
                ['']
            ];
            
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
            
            // Each team gets its own sheet
            teams.forEach(team => {
                const teamData = [
                    [team.name.toUpperCase()],
                    [''],
                    ['Total Budget', team.budget + 'L'],
                    ['Spent', (team.budget - team.remainingBudget).toFixed(2) + 'L'],
                    ['Remaining', team.remainingBudget.toFixed(2) + 'L'],
                    ['Squad Size', team.players.length + '/' + maxSquadSize],
                    [''],
                    ['Player Name', 'Type', 'Price (Lakhs)']
                ];
                
                team.players.forEach(p => {
                    teamData.push([p.name, p.type, p.soldPrice]);
                });
                
                // Add squad composition summary
                const batsmen = team.players.filter(p => p.type === 'Batsman').length;
                const bowlers = team.players.filter(p => p.type === 'Bowler').length;
                const allRounders = team.players.filter(p => p.type === 'All-Rounder').length;
                const keepers = team.players.filter(p => p.type === 'Wicket-Keeper').length;
                
                teamData.push(['']);
                teamData.push(['Squad Composition']);
                teamData.push(['Batsmen', batsmen]);
                teamData.push(['Bowlers', bowlers]);
                teamData.push(['All-Rounders', allRounders]);
                teamData.push(['Wicket-Keepers', keepers]);
                
                const teamSheet = XLSX.utils.aoa_to_sheet(teamData);
                XLSX.utils.book_append_sheet(wb, teamSheet, team.name.substring(0, 31)); // Excel sheet name limit
            });
            
            // All players sheet
            const allPlayersData = [
                ['ALL PLAYERS'],
                [''],
                ['Player Name', 'Type', 'Base Price', 'Status', 'Sold To', 'Final Price']
            ];
            
            players.forEach(p => {
                allPlayersData.push([
                    p.name,
                    p.type,
                    p.basePrice,
                    p.status === 'sold' ? 'SOLD' : p.status === 'unsold_final' ? 'UNSOLD' : 'PENDING',
                    p.soldTo || '-',
                    p.soldPrice || '-'
                ]);
            });
            
            const playersSheet = XLSX.utils.aoa_to_sheet(allPlayersData);
            XLSX.utils.book_append_sheet(wb, playersSheet, 'All Players');
            
            // Download
            XLSX.writeFile(wb, 'Auction_Results_' + new Date().toISOString().split('T')[0] + '.xlsx');
            
            alert('‚úÖ Teams exported to Excel successfully!');
        }

        function printSummaryReport() {
            if (teams.length === 0) {
                alert('No teams to print!');
                return;
            }
            
            // Switch to dashboard tab
            switchTab('dashboard');
            updateDashboard();
            
            // Wait a bit for dashboard to render, then print
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function updateSquadLimits() {
            minSquadSize = parseInt(document.getElementById('minSquadSize').value);
            maxSquadSize = parseInt(document.getElementById('maxSquadSize').value);
            
            // Validate that min is not greater than max
            if (minSquadSize > maxSquadSize) {
                alert('Minimum squad size cannot be greater than maximum squad size!');
                document.getElementById('minSquadSize').value = maxSquadSize;
                minSquadSize = maxSquadSize;
            }
            
            // Update display
            document.getElementById('minDisplay').textContent = minSquadSize;
            document.getElementById('maxDisplay').textContent = maxSquadSize;
            
            saveData();
        }

        function lockActionButtons() {
            buttonsLocked = true;
            const soldBtn = document.querySelector('.btn-primary[onclick="sellPlayer()"]');
            const unsoldBtn = document.querySelector('.btn-danger[onclick="unsoldPlayer()"]');
            const skipBtn = document.querySelector('.btn-warning[onclick="skipPlayer()"]');
            
            if (soldBtn) soldBtn.disabled = true;
            if (unsoldBtn) unsoldBtn.disabled = true;
            if (skipBtn) skipBtn.disabled = true;
            
            // Also disable bid buttons
            document.querySelectorAll('.btn-success[onclick*="increaseBid"]').forEach(btn => {
                btn.disabled = true;
            });
            
            // Disable team selector buttons
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }

        function unlockActionButtons() {
            buttonsLocked = false;
            const soldBtn = document.querySelector('.btn-primary[onclick="sellPlayer()"]');
            const unsoldBtn = document.querySelector('.btn-danger[onclick="unsoldPlayer()"]');
            const skipBtn = document.querySelector('.btn-warning[onclick="skipPlayer()"]');
            
            if (soldBtn) soldBtn.disabled = false;
            if (unsoldBtn) unsoldBtn.disabled = false;
            if (skipBtn) skipBtn.disabled = false;
            
            // Re-enable bid buttons
            document.querySelectorAll('.btn-success[onclick*="increaseBid"]').forEach(btn => {
                btn.disabled = false;
            });
            
            // Re-enable team selector buttons
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }

        function toggleTimerSettings() {
            const enabled = document.getElementById('timerEnabled').checked;
            document.getElementById('timerSettings').style.display = enabled ? 'block' : 'none';
            timerEnabled = enabled;
            saveData();
        }

        function startTimer() {
            if (!timerEnabled) return;
            
            stopTimer();
            timerDuration = parseInt(document.getElementById('timerDuration').value);
            remainingTime = timerDuration;
            timerPaused = false;
            
            document.getElementById('timerDisplay').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
            
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                if (!timerPaused) {
                    remainingTime--;
                    updateTimerDisplay();
                    
                    if (remainingTime <= 0) {
                        stopTimer();
                        playTimerAlert();
                        alert('‚è∞ Time is up for this player!');
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function pauseTimer() {
            timerPaused = true;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'inline-block';
        }

        function resumeTimer() {
            timerPaused = false;
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
        }

        function resetTimer() {
            remainingTime = timerDuration;
            timerPaused = false;
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('resumeBtn').style.display = 'none';
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerText').textContent = timeString;
            
            // Change color based on remaining time
            const timerText = document.getElementById('timerText');
            if (remainingTime <= 10) {
                timerText.style.color = '#dc3545'; // Red
                timerText.style.animation = 'pulse 1s infinite';
            } else if (remainingTime <= 30) {
                timerText.style.color = '#ffc107'; // Yellow
                timerText.style.animation = 'none';
            } else {
                timerText.style.color = '#667eea'; // Blue
                timerText.style.animation = 'none';
            }
        }

        function playTimerAlert() {
            // Create a simple beep sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // CRITICAL FIX #3: Resume audio context (required by modern browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function playHammerSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // CRITICAL FIX #3: Resume audio context (required by modern browsers)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Create multiple oscillators for a more complex hammer sound
            const createHammerHit = (time, frequency, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'triangle';
                oscillator.frequency.value = frequency;
                
                filter.type = 'lowpass';
                filter.frequency.value = 2000;
                
                gainNode.gain.setValueAtTime(0.6, time);
                gainNode.gain.exponentialRampToValueAtTime(0.01, time + duration);
                
                oscillator.start(time);
                oscillator.stop(time + duration);
            };
            
            // Create hammer strike sound - three quick hits
            const now = audioContext.currentTime;
            createHammerHit(now, 150, 0.15);
            createHammerHit(now + 0.15, 120, 0.15);
            createHammerHit(now + 0.3, 100, 0.2);
        }

        function playSoldAnnouncement(playerName, teamName, price) {
            // Play hammer sound
            playHammerSound();
            
            // Show sold overlay
            const overlay = document.getElementById('soldOverlay');
            const detailsText = document.getElementById('soldDetailsText');
            
            detailsText.innerHTML = `${playerName}<br>to ${teamName}<br>for ‚Çπ${price}L`;
            overlay.classList.add('show');
            
            // Text-to-speech announcement
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(
                    `Sold! ${playerName} to ${teamName} for ${price} lakhs`
                );
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Use a more authoritative voice if available
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Rishi') || voice.name.includes('India') || voice.name.includes('Hindi') || voice.name.includes('Google UK English Male') || voice.name.includes('Male')
                );
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
            
            // Hide overlay after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 3000);
        }

        function switchTab(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            // Remove active from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none'; // Explicitly hide all
            });
            
            // Activate clicked tab button
            event.target.classList.add('active');
            
            // Activate and show the target tab content
            const tabElement = document.getElementById(tabName);
            tabElement.classList.add('active');
            tabElement.style.display = 'block';
            tabElement.style.visibility = 'visible';
            tabElement.style.opacity = '1';
            
            // Force immediate scroll to top so tab is visible
            setTimeout(() => {
                window.scrollTo({top: 0, behavior: 'smooth'});
                tabElement.scrollIntoView({behavior: 'smooth', block: 'start'});
            }, 100);
            
            console.log('üìç Tab switched, calling update functions...');
            console.log('   Tab element display:', window.getComputedStyle(tabElement).display);
            console.log('   Tab element visibility:', window.getComputedStyle(tabElement).visibility);
            
            // Update the relevant tab content
            if (tabName === 'teams') {
                console.log('üë• Teams tab selected - updating overview');
                
                // CRITICAL FIX: Force teams tab to be visible
                const teamsTab = document.getElementById('teams');
                teamsTab.classList.add('active');
                teamsTab.style.display = 'block';
                
                updateTeamsOverview();
                
                // Check if content was added
                const teamsOverview = document.getElementById('teamsOverview');
                console.log('   teamsOverview innerHTML length:', teamsOverview.innerHTML.length);
                console.log('   teamsOverview display:', window.getComputedStyle(teamsOverview).display);
            }
            if (tabName === 'players') {
                console.log('üèÉ Players tab selected - updating list');
                
                // CRITICAL FIX: Force players tab to be visible
                const playersTab = document.getElementById('players');
                playersTab.classList.add('active');
                playersTab.style.display = 'block';
                
                updatePlayersList();
                
                // Check if content was added
                const playersList = document.getElementById('playersList');
                console.log('   playersList innerHTML length:', playersList.innerHTML.length);
                console.log('   playersList display:', window.getComputedStyle(playersList).display);
            }
            if (tabName === 'dashboard') {
                console.log('üìä Dashboard tab selected - updating dashboard');
                
                // CRITICAL FIX: Force dashboard to be visible
                const dashTab = document.getElementById('dashboard');
                dashTab.classList.add('active');
                dashTab.style.display = 'block';
                
                updateDashboard();
                
                // Check if content was added
                const dashboardContainer = document.getElementById('teamsDashboard');
                console.log('   teamsDashboard innerHTML length:', dashboardContainer.innerHTML.length);
                console.log('   teamsDashboard display:', window.getComputedStyle(dashboardContainer).display);
            }
            if (tabName === 'presentation') {
                console.log('üìΩÔ∏è Presentation tab selected - updating presentation');
                updatePresentationMode();
            }
            
            console.log('‚úÖ Tab switch complete');
        }

        function updatePresentationMode() {
            // Update current player if auction is running
            if (auctionStarted && currentPlayerIndex >= 0 && currentPlayerIndex < players.length) {
                const player = players[currentPlayerIndex];
                
                document.getElementById('presentationCurrentPlayer').style.display = 'block';
                
                // Player image
                const imageContainer = document.getElementById('presentationPlayerImage');
                if (player.image) {
                    imageContainer.innerHTML = `<img src="${player.image}" class="presentation-player-image" alt="${player.name}">`;
                } else {
                    const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    imageContainer.innerHTML = `<div class="presentation-player-placeholder">${initials}</div>`;
                }
                
                document.getElementById('presentationPlayerName').textContent = player.name;
                document.getElementById('presentationPlayerType').textContent = player.type;
                document.getElementById('presentationBasePrice').textContent = player.basePrice;
                document.getElementById('presentationBid').textContent = currentBidAmount;
                
                // Timer
                if (timerEnabled && remainingTime > 0) {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById('presentationTimer').textContent = `‚è±Ô∏è ${timeString}`;
                    document.getElementById('presentationTimer').style.display = 'block';
                    
                    // Color coding
                    const timerEl = document.getElementById('presentationTimer');
                    if (remainingTime <= 10) {
                        timerEl.style.color = '#ef4444';
                    } else if (remainingTime <= 30) {
                        timerEl.style.color = '#f59e0b';
                    } else {
                        timerEl.style.color = '#10b981';
                    }
                } else {
                    document.getElementById('presentationTimer').style.display = 'none';
                }
            } else {
                document.getElementById('presentationCurrentPlayer').style.display = 'none';
            }
            
            // Update teams grid
            const teamsContainer = document.getElementById('presentationTeams');
            teamsContainer.innerHTML = teams.map((team, index) => {
                const isSelected = selectedTeam === index;
                const playerCount = team.players.length;
                const spent = team.budget - team.remainingBudget;
                
                const teamLogoHtml = team.logo 
                    ? `<img src="${team.logo}" class="team-logo-presentation" alt="${team.name}">`
                    : `<div class="team-logo-presentation" style="background: linear-gradient(135deg, #0f3460 0%, #16213e 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 50px;">${team.name.substring(0, 2).toUpperCase()}</div>`;
                
                return `
                    <div class="presentation-team-card ${isSelected ? 'highlight' : ''}">
                        <div style="text-align: center;">
                            ${teamLogoHtml}
                        </div>
                        <div class="presentation-team-name">${team.name}</div>
                        <div class="presentation-team-budget">‚Çπ${team.remainingBudget.toFixed(2)}L</div>
                        <div class="presentation-team-info">
                            <strong>Remaining Budget</strong>
                        </div>
                        <div class="presentation-team-info" style="margin-top: 20px;">
                            Spent: ‚Çπ${spent.toFixed(2)}L | Players: ${playerCount}/${maxSquadSize}
                        </div>
                        ${isSelected ? '<div style="text-align: center; margin-top: 20px; font-size: 2em;">üëà BIDDING</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function presentationRefresh() {
            updatePresentationMode();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // REAL-TIME SYNC SYSTEM (Two mechanisms):
        // 1. setInterval: Updates presentation mode every second (same tab)
        // 2. storage event: Syncs data across tabs/windows instantly
        // Auto-update presentation mode during auction
        setInterval(() => {
            const presentationTab = document.getElementById('presentation');
            if (presentationTab && presentationTab.classList.contains('active')) {
                updatePresentationMode();
            }
            
            // Also update dashboard if it's active
            const dashboardTab = document.getElementById('dashboard');
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                updateDashboard();
            }
        }, 1000); // Update every second

        function updateDashboard() {
            console.log('üîÑ updateDashboard called');
            console.log('Teams:', teams.length);
            console.log('Players sold:', players.filter(p => p.status === 'sold').length);
            
            // Update summary stats
            const totalBudget = teams.reduce((sum, team) => sum + team.budget, 0);
            const totalSpent = teams.reduce((sum, team) => sum + (team.budget - team.remainingBudget), 0);
            const playersSold = players.filter(p => p.status === 'sold').length;

            document.getElementById('dashTotalTeams').textContent = teams.length;
            document.getElementById('dashTotalBudget').textContent = totalBudget.toFixed(0);
            document.getElementById('dashTotalSpent').textContent = totalSpent.toFixed(2);
            document.getElementById('dashPlayersSold').textContent = playersSold;

            // Generate team dashboards
            const dashboardContainer = document.getElementById('teamsDashboard');
            
            if (!dashboardContainer) {
                console.error('‚ùå Dashboard container not found!');
                return;
            }
            
            if (teams.length === 0) {
                console.log('‚ö†Ô∏è No teams to display');
                dashboardContainer.innerHTML = `
                    <div class="dashboard-empty-state">
                        <h3>No teams added yet</h3>
                        <p>Add teams in the Setup tab to see the dashboard</p>
                    </div>
                `;
                return;
            }

            console.log('‚úÖ Rendering dashboard for', teams.length, 'teams');
            
            dashboardContainer.innerHTML = teams.map((team, teamIndex) => {
                console.log(`Team ${teamIndex}: ${team.name}, Players: ${team.players ? team.players.length : 'UNDEFINED'}`);
                
                // CRITICAL FIX: Ensure team.players exists
                if (!team.players) {
                    console.error(`‚ùå Team ${team.name} has no players array! Initializing...`);
                    team.players = [];
                }
                
                const playerCount = team.players.length;
                const spent = team.budget - team.remainingBudget;
                const spentPercentage = ((spent / team.budget) * 100).toFixed(1);

                // Determine squad status
                let squadBadgeClass = 'incomplete';
                let squadBadgeText = `Need ${minSquadSize - playerCount} more`;
                let squadBadgeIcon = '‚ö†Ô∏è';

                if (playerCount >= maxSquadSize) {
                    squadBadgeClass = 'full';
                    squadBadgeText = 'Full Squad';
                    squadBadgeIcon = 'üéØ';
                } else if (playerCount >= minSquadSize) {
                    squadBadgeClass = 'complete';
                    squadBadgeText = 'Squad Complete';
                    squadBadgeIcon = '‚úÖ';
                }

                // Group players by type
                const batsmen = team.players.filter(p => p.type === 'Batsman');
                const bowlers = team.players.filter(p => p.type === 'Bowler');
                const allRounders = team.players.filter(p => p.type === 'All-Rounder');
                const keepers = team.players.filter(p => p.type === 'Wicket-Keeper');

                const teamLogoHtml = team.logo 
                    ? `<img src="${team.logo}" class="team-logo-large" alt="${team.name}" style="margin-bottom: 15px;">`
                    : '';

                return `
                    <div class="dashboard-team-card">
                        <div class="dashboard-team-header">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                ${teamLogoHtml}
                                <div class="dashboard-team-name">${team.name}</div>
                            </div>
                            <div class="dashboard-purse">
                                <div class="dashboard-purse-item">
                                    <div class="dashboard-purse-label">Remaining</div>
                                    <div class="dashboard-purse-value dashboard-purse-remaining">‚Çπ${team.remainingBudget.toFixed(2)}L</div>
                                </div>
                                <div class="dashboard-purse-item">
                                    <div class="dashboard-purse-label">Spent</div>
                                    <div class="dashboard-purse-value dashboard-purse-spent">‚Çπ${spent.toFixed(2)}L</div>
                                </div>
                                <div class="dashboard-purse-item">
                                    <div class="dashboard-purse-label">Used</div>
                                    <div class="dashboard-purse-value" style="color: #0f3460;">${spentPercentage}%</div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-squad-info">
                            <div class="dashboard-info-badge ${squadBadgeClass}">
                                ${squadBadgeIcon} ${squadBadgeText}
                            </div>
                            <div class="dashboard-info-badge" style="background: #f1f5f9; color: #475569; border: 2px solid #cbd5e1;">
                                üë• ${playerCount}/${maxSquadSize} Players
                            </div>
                            ${batsmen.length > 0 ? `<div class="dashboard-info-badge" style="background: #fef3c7; color: #92400e; border: 2px solid #fbbf24;">üèè ${batsmen.length} Batsmen</div>` : ''}
                            ${bowlers.length > 0 ? `<div class="dashboard-info-badge" style="background: #dbeafe; color: #1e40af; border: 2px solid #60a5fa;">‚öæ ${bowlers.length} Bowlers</div>` : ''}
                            ${allRounders.length > 0 ? `<div class="dashboard-info-badge" style="background: #e9d5ff; color: #6b21a8; border: 2px solid #a855f7;">üåü ${allRounders.length} All-Rounders</div>` : ''}
                            ${keepers.length > 0 ? `<div class="dashboard-info-badge" style="background: #d1fae5; color: #065f46; border: 2px solid #34d399;">üß§ ${keepers.length} Keepers</div>` : ''}
                        </div>

                        ${team.players.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4 style="color: #475569; font-size: 14px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Squad Members</h4>
                                <div class="dashboard-players-grid">
                                    ${team.players.map(p => {
                                        const playerImageHtml = p.image 
                                            ? `<img src="${p.image}" class="player-image" alt="${p.name}" style="width: 45px; height: 45px;">`
                                            : `<div class="player-placeholder" style="width: 45px; height: 45px; font-size: 16px;">${p.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</div>`;
                                        
                                        return `
                                            <div class="dashboard-player-card">
                                                ${playerImageHtml}
                                                <div class="dashboard-player-info">
                                                    <div class="dashboard-player-name">${p.name}</div>
                                                    <div class="dashboard-player-type">${p.type}</div>
                                                </div>
                                                <div class="dashboard-player-price">‚Çπ${p.soldPrice}L</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="dashboard-empty-state">
                                <p>No players purchased yet</p>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function downloadExcelTemplate() {
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Teams sheet with logo URL column
            const teamsData = [
                ['Team Name', 'Budget (in Lakhs)', 'Logo URL (optional)'],
                ['Mumbai Indians', '1000', 'https://example.com/mi-logo.png'],
                ['Chennai Super Kings', '1000', 'https://example.com/csk-logo.png'],
                ['Royal Challengers', '1000', ''],
                ['Kolkata Knights', '1000', '']
            ];
            const teamsSheet = XLSX.utils.aoa_to_sheet(teamsData);
            XLSX.utils.book_append_sheet(wb, teamsSheet, 'Teams');
            
            // Players sheet with image URL column
            const playersData = [
                ['Player Name', 'Type', 'Base Price (in Lakhs)', 'Image URL (optional)'],
                ['Virat Kohli', 'Batsman', '50', 'https://example.com/virat.jpg'],
                ['Rohit Sharma', 'Batsman', '45', 'https://example.com/rohit.jpg'],
                ['Jasprit Bumrah', 'Bowler', '75', ''],
                ['Rashid Khan', 'Bowler', '60', ''],
                ['Hardik Pandya', 'All-Rounder', '65', ''],
                ['Ravindra Jadeja', 'All-Rounder', '55', ''],
                ['MS Dhoni', 'Wicket-Keeper', '70', ''],
                ['Rishabh Pant', 'Wicket-Keeper', '50', '']
            ];
            const playersSheet = XLSX.utils.aoa_to_sheet(playersData);
            XLSX.utils.book_append_sheet(wb, playersSheet, 'Players');
            
            // Instructions sheet
            const instructionsData = [
                ['IPL Auction Tool - Excel Template Instructions'],
                [''],
                ['HOW TO USE THIS TEMPLATE:'],
                [''],
                ['1. TEAMS SHEET:'],
                ['   - Column A: Enter team names'],
                ['   - Column B: Enter team budgets in lakhs (e.g., 1000 for ‚Çπ1000 lakhs)'],
                ['   - Column C: Enter team logo URL (optional)'],
                ['     * You can paste logo image URLs from the internet'],
                ['     * Leave blank if no logo available'],
                ['     * Logo will be downloaded and displayed in dashboards'],
                ['   - You can add as many teams as you want'],
                ['   - Delete the example teams and add your own'],
                [''],
                ['2. PLAYERS SHEET:'],
                ['   - Column A: Enter player names'],
                ['   - Column B: Enter player type (must be exactly one of these):'],
                ['     * Batsman'],
                ['     * Bowler'],
                ['     * All-Rounder'],
                ['     * Wicket-Keeper'],
                ['   - Column C: Enter base price in lakhs (e.g., 50 for ‚Çπ50 lakhs)'],
                ['   - Column D: Enter image URL (optional)'],
                ['     * You can paste image URLs from the internet'],
                ['     * Leave blank if no image available'],
                ['     * Image will be downloaded and displayed in the auction'],
                ['   - You can add as many players as you want'],
                ['   - Delete the example players and add your own'],
                [''],
                ['3. ADDING PLAYER IMAGES:'],
                ['   METHOD 1 - Use Image URLs:'],
                ['   - Find player images online (Google Images, Wikipedia, etc.)'],
                ['   - Right-click on image ‚Üí "Copy image address"'],
                ['   - Paste the URL in Column D'],
                ['   - Example: https://example.com/player.jpg'],
                [''],
                ['   METHOD 2 - Use Local Images:'],
                ['   - Upload your images to a free image hosting site like:'],
                ['     * imgur.com'],
                ['     * postimages.org'],
                ['     * imgbb.com'],
                ['   - Copy the direct image link'],
                ['   - Paste in Column D'],
                [''],
                ['   METHOD 3 - No Image:'],
                ['   - Leave Column D blank'],
                ['   - Player initials will be shown instead'],
                [''],
                ['4. IMPORTING:'],
                ['   - Save this file after editing'],
                ['   - In the auction tool, click "Import Excel File"'],
                ['   - Select this saved file'],
                ['   - All your teams, players, and images will be loaded!'],
                [''],
                ['IMPORTANT NOTES:'],
                ['   - Do not change the column headers (first row)'],
                ['   - Player type must match exactly (case-sensitive)'],
                ['   - All prices are in lakhs (1 lakh = 100,000)'],
                ['   - Make sure there are no empty rows between data'],
                ['   - Image URLs must be direct links to images (ending in .jpg, .png, etc.)'],
                ['   - Images will be automatically converted and stored locally'],
                [''],
                ['VALID PLAYER TYPES:'],
                ['   Batsman, Bowler, All-Rounder, Wicket-Keeper'],
                [''],
                ['IMAGE URL TIPS:'],
                ['   - Use https:// URLs (not http://)'],
                ['   - Make sure the URL points directly to an image file'],
                ['   - Test the URL by pasting it in your browser'],
                ['   - If image does not load, leave blank and add manually later']
            ];
            const instructionsSheet = XLSX.utils.aoa_to_sheet(instructionsData);
            XLSX.utils.book_append_sheet(wb, instructionsSheet, 'Instructions');
            
            // Download file
            XLSX.writeFile(wb, 'IPL_Auction_Template.xlsx');
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Clear existing data
                    teams = [];
                    players = [];
                    
                    // CRITICAL FIX #4: Make Excel import human-proof with flexible headers
                    function normalizeHeader(header) {
                        return String(header).toLowerCase().replace(/\s/g, '').replace(/[()]/g, '');
                    }
                    
                    function findColumnIndex(headers, possibleNames) {
                        const normalizedHeaders = headers.map(h => normalizeHeader(h || ''));
                        for (let name of possibleNames) {
                            const normalizedName = normalizeHeader(name);
                            const index = normalizedHeaders.indexOf(normalizedName);
                            if (index !== -1) return index;
                        }
                        return -1;
                    }
                    
                    // Read Teams sheet
                    if (workbook.SheetNames.includes('Teams')) {
                        const teamsSheet = workbook.Sheets['Teams'];
                        const teamsJson = XLSX.utils.sheet_to_json(teamsSheet, { header: 1 });
                        
                        if (teamsJson.length < 2) {
                            throw new Error('Teams sheet is empty or has no data rows');
                        }
                        
                        const headers = teamsJson[0];
                        const nameCol = findColumnIndex(headers, ['TeamName', 'Team Name', 'Name', 'Team']);
                        const budgetCol = findColumnIndex(headers, ['Budget', 'Budget(inLakhs)', 'BudgetinLakhs', 'TeamBudget']);
                        const logoCol = findColumnIndex(headers, ['LogoURL', 'Logo URL', 'Logo', 'ImageURL', 'Image']);
                        
                        if (nameCol === -1 || budgetCol === -1) {
                            throw new Error('Could not find required columns in Teams sheet. Need: Team Name and Budget');
                        }
                        
                        let teamsToLoad = [];
                        let teamLogosToLoad = 0;
                        
                        for (let i = 1; i < teamsJson.length; i++) {
                            const row = teamsJson[i];
                            if (row[nameCol] && row[budgetCol]) {
                                const teamName = String(row[nameCol]).trim();
                                
                                // Check for duplicates in the import
                                const duplicateInImport = teamsToLoad.find(t => t.name.toLowerCase() === teamName.toLowerCase());
                                if (duplicateInImport) {
                                    console.warn(`Duplicate team name in Excel: "${teamName}" - skipping`);
                                    continue; // Skip this duplicate
                                }
                                
                                const logoUrl = (logoCol !== -1 && row[logoCol]) ? String(row[logoCol]).trim() : null;
                                
                                teamsToLoad.push({
                                    name: teamName,
                                    budget: parseFloat(row[budgetCol]),
                                    remainingBudget: parseFloat(row[budgetCol]),
                                    players: [],
                                    logoUrl: logoUrl
                                });
                                
                                if (logoUrl) {
                                    teamLogosToLoad++;
                                }
                            }
                        }
                        
                        // Function to load logo from URL
                        async function loadLogoFromUrl(url) {
                            return new Promise((resolve, reject) => {
                                const img = new Image();
                                img.crossOrigin = 'anonymous';
                                img.onload = function() {
                                    try {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0);
                                        const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                                        console.log(`‚úÖ Team logo loaded: ${url.substring(0, 50)}...`);
                                        resolve(dataURL);
                                    } catch (e) {
                                        console.error(`‚ùå Canvas error for logo ${url}:`, e);
                                        resolve(null);
                                    }
                                };
                                img.onerror = function(e) {
                                    console.error(`‚ùå Logo load failed: ${url}`, e);
                                    resolve(null);
                                };
                                img.src = url;
                            });
                        }
                        
                        // Load team logos if any
                        if (teamLogosToLoad > 0) {
                            Promise.all(teamsToLoad.map(async (team) => {
                                if (team.logoUrl) {
                                    const logoData = await loadLogoFromUrl(team.logoUrl);
                                    team.logo = logoData;
                                    delete team.logoUrl;
                                } else {
                                    team.logo = null;
                                    delete team.logoUrl;
                                }
                                return team;
                            })).then((loadedTeams) => {
                                teams = loadedTeams;
                                continueExcelImport();
                            });
                        } else {
                            teams = teamsToLoad.map(t => {
                                t.logo = null;
                                delete t.logoUrl;
                                return t;
                            });
                            continueExcelImport();
                        }
                        
                        function continueExcelImport() {
                    
                    // Read Players sheet
                    if (workbook.SheetNames.includes('Players')) {
                        const playersSheet = workbook.Sheets['Players'];
                        const playersJson = XLSX.utils.sheet_to_json(playersSheet, { header: 1 });
                        
                        if (playersJson.length < 2) {
                            throw new Error('Players sheet is empty or has no data rows');
                        }
                        
                        const headers = playersJson[0];
                        const nameCol = findColumnIndex(headers, ['PlayerName', 'Player Name', 'Name', 'Player']);
                        const typeCol = findColumnIndex(headers, ['Type', 'PlayerType', 'Player Type', 'Category']);
                        const priceCol = findColumnIndex(headers, ['BasePrice', 'Base Price', 'Price', 'BasePriceinLakhs']);
                        const imageCol = findColumnIndex(headers, ['ImageURL', 'Image URL', 'Image', 'Photo', 'PhotoURL']);
                        
                        if (nameCol === -1 || typeCol === -1 || priceCol === -1) {
                            throw new Error('Could not find required columns in Players sheet. Need: Player Name, Type, and Base Price');
                        }
                        
                        let playersToLoad = [];
                        let imagesProcessed = 0;
                        let totalImages = 0;
                        
                        for (let i = 1; i < playersJson.length; i++) {
                            const row = playersJson[i];
                            if (row[nameCol] && row[typeCol] && row[priceCol]) {
                                const playerName = String(row[nameCol]).trim();
                                const playerType = String(row[typeCol]).trim();
                                const validTypes = ['Batsman', 'Bowler', 'All-Rounder', 'Wicket-Keeper'];
                                
                                if (validTypes.includes(playerType)) {
                                    // Check for duplicates in the import
                                    const duplicateInImport = playersToLoad.find(p => p.name.toLowerCase() === playerName.toLowerCase());
                                    if (duplicateInImport) {
                                        console.warn(`Duplicate player name in Excel: "${playerName}" - skipping`);
                                        continue; // Skip this duplicate
                                    }
                                    
                                    const imageUrl = (imageCol !== -1 && row[imageCol]) ? String(row[imageCol]).trim() : null;
                                    
                                    playersToLoad.push({
                                        name: playerName,
                                        type: playerType,
                                        basePrice: parseFloat(row[priceCol]),
                                        status: 'unsold',
                                        soldTo: null,
                                        soldPrice: 0,
                                        imageUrl: imageUrl
                                    });
                                    
                                    if (imageUrl) {
                                        totalImages++;
                                    }
                                }
                            }
                        }
                        
                        // Function to load image from URL and convert to base64
                        async function loadImageFromUrl(url) {
                            return new Promise((resolve, reject) => {
                                const img = new Image();
                                img.crossOrigin = 'anonymous';
                                img.onload = function() {
                                    try {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0);
                                        const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                                        console.log(`‚úÖ Image loaded: ${url.substring(0, 50)}...`);
                                        resolve(dataURL);
                                    } catch (e) {
                                        console.error(`‚ùå Canvas error for ${url}:`, e);
                                        resolve(null);
                                    }
                                };
                                img.onerror = function(e) {
                                    console.error(`‚ùå Image load failed: ${url}`, e);
                                    resolve(null);
                                };
                                img.src = url;
                            });
                        }
                        
                        // Load all players with images
                        if (totalImages > 0) {
                            alert(`Loading ${totalImages} player images. This may take a moment...`);
                            
                            Promise.all(playersToLoad.map(async (player) => {
                                if (player.imageUrl) {
                                    const imageData = await loadImageFromUrl(player.imageUrl);
                                    player.image = imageData;
                                    delete player.imageUrl;
                                    imagesProcessed++;
                                } else {
                                    player.image = null;
                                    delete player.imageUrl;
                                }
                                return player;
                            })).then((loadedPlayers) => {
                                players = loadedPlayers;
                                
                                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                console.log('üì¶ EXCEL IMPORT COMPLETED');
                                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                console.log('Teams array length:', teams.length);
                                console.log('Players array length:', players.length);
                                console.log('Teams:', teams);
                                console.log('Players:', players);
                                console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                                console.log('üîÑ Calling update functions...');
                                
                                updateTeamsList();
                                console.log('‚úÖ updateTeamsList() called');
                                
                                updateStats();
                                console.log('‚úÖ updateStats() called');
                                
                                updatePlayersList();
                                console.log('‚úÖ updatePlayersList() called');
                                
                                updateTeamsOverview();
                                console.log('‚úÖ updateTeamsOverview() called');
                                
                                updateDashboard();
                                console.log('‚úÖ updateDashboard() called');
                                
                                saveData();
                                console.log('‚úÖ saveData() called');
                                
                                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                                
                                alert(`Excel imported successfully!\n${teams.length} teams and ${players.length} players loaded.\n${imagesProcessed} player images loaded successfully.`);
                            });
                        } else {
                            // No images to load
                            players = playersToLoad.map(p => {
                                p.image = null;
                                delete p.imageUrl;
                                return p;
                            });
                            
                            updateTeamsList();
                            updateStats();
                            updatePlayersList(); // Update Players tab
                            updateTeamsOverview(); // Update Teams tab
                            updateDashboard(); // Update Dashboard
                            saveData();
                            
                            alert(`Excel imported successfully!\n${teams.length} teams and ${players.length} players loaded.`);
                        }
                    } else {
                        updateTeamsList();
                        updateStats();
                        updateTeamsOverview(); // Update Teams tab
                        updateDashboard(); // Update Dashboard
                        saveData();
                        
                        alert(`Excel imported successfully!\n${teams.length} teams loaded.`);
                    }
                        }
                    } else {
                        continueExcelImport();
                    }
                    
                } catch (error) {
                    alert('Error importing Excel file. Please check the file format and try again.\n\nError: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset file input
            event.target.value = '';
        }

        function addTeam() {
            const name = document.getElementById('teamName').value.trim();
            const budget = parseFloat(document.getElementById('teamBudget').value);
            const logoFile = document.getElementById('teamLogo').files[0];
            
            if (!name || !budget) {
                alert('Please enter team name and budget');
                return;
            }
            
            // CRITICAL FIX: Check for duplicate team names
            const duplicateTeam = teams.find(t => t.name.toLowerCase() === name.toLowerCase());
            if (duplicateTeam) {
                alert(`‚ö†Ô∏è DUPLICATE TEAM NAME\n\nA team named "${duplicateTeam.name}" already exists!\n\nPlease use a different team name to avoid confusion during the auction.`);
                return;
            }
            
            if (logoFile) {
                // CRITICAL FIX #2: Compress image to prevent storage overflow
                compressImage(logoFile, 300, 300, 0.7).then(compressedDataUrl => {
                    teams.push({
                        name: name,
                        budget: budget,
                        remainingBudget: budget,
                        players: [],
                        logo: compressedDataUrl
                    });
                    
                    document.getElementById('teamName').value = '';
                    document.getElementById('teamBudget').value = '';
                    document.getElementById('teamLogo').value = '';
                    document.getElementById('teamLogoPreview').style.display = 'none';
                    
                    updateTeamsList();
                    saveData();
                });
            } else {
                teams.push({
                    name: name,
                    budget: budget,
                    remainingBudget: budget,
                    players: [],
                    logo: null
                });
                
                document.getElementById('teamName').value = '';
                document.getElementById('teamBudget').value = '';
                document.getElementById('teamLogo').value = '';
                
                updateTeamsList();
                saveData();
            }
        }

        // Preview team logo before adding
        document.addEventListener('DOMContentLoaded', function() {
            const teamLogoInput = document.getElementById('teamLogo');
            if (teamLogoInput) {
                teamLogoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('teamLogoPreviewImg').src = e.target.result;
                            document.getElementById('teamLogoPreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const type = document.getElementById('playerType').value;
            const basePrice = parseFloat(document.getElementById('basePrice').value);
            const imageFile = document.getElementById('playerImage').files[0];
            
            if (!name || !basePrice) {
                alert('Please enter player name and base price');
                return;
            }
            
            // CRITICAL FIX: Check for duplicate player names
            const duplicatePlayer = players.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (duplicatePlayer) {
                alert(`‚ö†Ô∏è DUPLICATE PLAYER NAME\n\nA player named "${duplicatePlayer.name}" already exists!\n\nPlease use a different name or add a distinguishing detail (e.g., "John Smith (Mumbai)" vs "John Smith (Delhi)") to avoid confusion during the auction.`);
                return;
            }
            
            if (imageFile) {
                // CRITICAL FIX #2: Compress image to prevent storage overflow
                compressImage(imageFile, 300, 300, 0.7).then(compressedDataUrl => {
                    players.push({
                        name: name,
                        type: type,
                        basePrice: basePrice,
                        status: 'unsold',
                        soldTo: null,
                        soldPrice: 0,
                        image: compressedDataUrl
                    });
                    
                    document.getElementById('playerName').value = '';
                    document.getElementById('basePrice').value = '';
                    document.getElementById('playerImage').value = '';
                    document.getElementById('imagePreview').style.display = 'none';
                    
                    updateStats();
                    saveData();
                });
            } else {
                players.push({
                    name: name,
                    type: type,
                    basePrice: basePrice,
                    status: 'unsold',
                    soldTo: null,
                    soldPrice: 0,
                    image: null
                });
                
                document.getElementById('playerName').value = '';
                document.getElementById('basePrice').value = '';
                document.getElementById('playerImage').value = '';
                
                updateStats();
                saveData();
            }
        }

        // CRITICAL FIX #2: Image compression function
        function compressImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG with quality compression
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Log compression results
                        const originalSize = e.target.result.length;
                        const compressedSize = compressedDataUrl.length;
                        console.log(`Image compressed: ${(originalSize/1024).toFixed(2)}KB ‚Üí ${(compressedSize/1024).toFixed(2)}KB (${((compressedSize/originalSize)*100).toFixed(1)}% of original)`);
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = function() {
                        reject(new Error('Failed to load image'));
                    };
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                reader.readAsDataURL(file);
            });
        }

        // Preview image before adding
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('playerImage');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function updateTeamsList() {
            const list = document.getElementById('teamsList');
            list.innerHTML = teams.map((team, index) => {
                const teamLogoHtml = team.logo 
                    ? `<img src="${team.logo}" class="team-logo" alt="${team.name}">`
                    : `<div class="team-placeholder-logo">${team.name.substring(0, 2).toUpperCase()}</div>`;
                
                return `
                <div class="team-card">
                    <h3>
                        ${teamLogoHtml}
                        <span>${team.name}</span>
                    </h3>
                    <div class="team-info"><span>Budget:</span> <span>‚Çπ${team.budget}L</span></div>
                    <div class="team-info"><span>Remaining:</span> <span>‚Çπ${team.remainingBudget.toFixed(2)}L</span></div>
                    <div class="team-info"><span>Players:</span> <span>${team.players.length}</span></div>
                    <button class="btn btn-danger" onclick="deleteTeam(${index})" style="margin-top: 10px; width: 100%;">Delete</button>
                </div>
            `}).join('');
        }

        function deleteTeam(index) {
            if (confirm('Are you sure you want to delete this team?')) {
                teams.splice(index, 1);
                updateTeamsList();
                saveData();
            }
        }

        function startAuction() {
            if (teams.length === 0) {
                alert('Please add teams first!');
                return;
            }
            if (players.length === 0) {
                alert('Please add players first!');
                return;
            }
            
            auctionStarted = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('auctionMessage').style.display = 'none';
            document.getElementById('pauseAuctionBtn').style.display = 'inline-block';
            
            // Organize players into sets if enabled
            if (setsEnabled) {
                const distribution = organizePlayersIntoSets();
                const set1Type = document.getElementById('set1Type').value;
                const set2Type = document.getElementById('set2Type').value;
                const set3Type = document.getElementById('set3Type').value;
                const set4Type = document.getElementById('set4Type').value;
                
                alert(`üé≤ SET-BASED AUCTION ACTIVATED!\n\n` +
                    `Set 1 (${set1Type}): ${distribution.set1} players\n` +
                    `Set 2 (${set2Type}): ${distribution.set2} players\n` +
                    `Set 3 (${set3Type}): ${distribution.set3} players\n` +
                    `Set 4 (${set4Type}): ${distribution.set4} players\n` +
                    `Remaining: ${distribution.remaining} players\n\n` +
                    `Players have been randomly shuffled within each set!`);
            }
            
            currentPlayerIndex = -1; // Reset to start
            nextPlayer();
        }

        function nextPlayer() {
            // CRITICAL FIX #2: If using sets and auctionOrder is exhausted, check for remaining unsold players
            if (setsEnabled && auctionOrder.length === 0) {
                // Repopulate auctionOrder with any remaining unsold players
                const remainingUnsold = players
                    .map((p, index) => ({player: p, index: index}))
                    .filter(item => item.player.status === 'unsold')
                    .map(item => item.index);
                
                if (remainingUnsold.length > 0) {
                    auctionOrder = shuffleArray(remainingUnsold);
                    console.log(`Repopulated auctionOrder with ${remainingUnsold.length} remaining unsold players`);
                }
            }
            
            if (setsEnabled && auctionOrder.length > 0) {
                // Use set-based order
                // Find next player from the auction order that is still unsold
                let found = false;
                while (auctionOrder.length > 0 && !found) {
                    const nextIndex = auctionOrder.shift(); // Get and remove first element
                    if (players[nextIndex].status === 'unsold') {
                        currentPlayerIndex = nextIndex;
                        found = true;
                    }
                }
                
                if (!found) {
                    stopTimer();
                    alert('Auction completed! All players have been processed.');
                    document.getElementById('currentPlayerArea').style.display = 'none';
                    document.getElementById('nextBtn').style.display = 'none';
                    return;
                }
            } else {
                // Use sequential order (original behavior)
                currentPlayerIndex++;
                
                while (currentPlayerIndex < players.length && players[currentPlayerIndex].status !== 'unsold') {
                    currentPlayerIndex++;
                }
                
                if (currentPlayerIndex >= players.length) {
                    stopTimer();
                    alert('Auction completed! All players have been processed.');
                    document.getElementById('currentPlayerArea').style.display = 'none';
                    document.getElementById('nextBtn').style.display = 'none';
                    return;
                }
            }
            
            const player = players[currentPlayerIndex];
            currentBidAmount = 50000;
            
            // CRITICAL FIX: Clear visual selection IMMEDIATELY (synchronously) - NO setTimeout!
            // This prevents "ghost selection" bug where old selection persists
            selectedTeam = null;
            document.querySelectorAll('.team-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.getElementById('currentPlayerArea').style.display = 'block';
            
            // Display player image or placeholder
            const imageContainer = document.getElementById('currentPlayerImageContainer');
            if (player.image) {
                imageContainer.innerHTML = `<img src="${player.image}" class="player-image-large" alt="${player.name}">`;
            } else {
                const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                imageContainer.innerHTML = `<div class="player-placeholder-large">${initials}</div>`;
            }
            
            document.getElementById('currentPlayerName').textContent = player.name;
            document.getElementById('currentPlayerType').textContent = player.type;
            document.getElementById('currentBasePrice').textContent = player.basePrice;
            document.getElementById('currentBid').textContent = currentBidAmount;
            
            const teamSelector = document.getElementById('teamSelector');
            teamSelector.innerHTML = teams.map((team, index) => 
                `<button class="team-btn" onclick="selectTeam(${index})">${team.name}</button>`
            ).join('');
            
            updateStats();
            
            // Ensure buttons are unlocked for new player
            unlockActionButtons();
            
            // Start timer if enabled
            startTimer();
        }

        function selectTeam(index) {
            selectedTeam = index;
            document.querySelectorAll('.team-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
            });
            
            // Budget alert
            const team = teams[index];
            if (currentBidAmount > team.remainingBudget) {
                alert(`‚ö†Ô∏è BUDGET ALERT!\n\n${team.name} has only ‚Çπ${team.remainingBudget.toFixed(2)}L remaining.\nCurrent bid: ‚Çπ${currentBidAmount}L\n\nThis team cannot afford this player at current bid!`);
            } else if (team.remainingBudget - currentBidAmount < 10) {
                alert(`‚ö†Ô∏è LOW BUDGET WARNING!\n\n${team.name} will have only ‚Çπ${(team.remainingBudget - currentBidAmount).toFixed(2)}L remaining after this purchase.\n\nBe careful with remaining budget!`);
            }
        }

        function increaseBid(amount = 5) {
            currentBidAmount += amount;
            document.getElementById('currentBid').textContent = currentBidAmount;
        }

        function handleCustomBidDropdown() {
            const dropdown = document.getElementById('customBidDropdown');
            const customInput = document.getElementById('customBidInput');
            
            if (dropdown.value === 'custom') {
                customInput.style.display = 'block';
                document.getElementById('customBidValue').focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        function applyCustomBid() {
            const dropdown = document.getElementById('customBidDropdown');
            const value = dropdown.value;
            
            if (!value || value === '') {
                alert('Please select an amount from the dropdown');
                return;
            }
            
            if (value === 'custom') {
                alert('Please enter a custom amount in the input field below and click "Add"');
                return;
            }
            
            const amount = parseFloat(value);
            currentBidAmount += amount;
            document.getElementById('currentBid').textContent = currentBidAmount;
            
            // Reset dropdown
            dropdown.value = '';
            document.getElementById('customBidInput').style.display = 'none';
        }

        function applyCustomBidValue() {
            const input = document.getElementById('customBidValue');
            const value = parseFloat(input.value);
            
            if (!value || value <= 0) {
                alert('Please enter a valid amount greater than 0');
                return;
            }
            
            currentBidAmount += value;
            document.getElementById('currentBid').textContent = currentBidAmount;
            
            // Reset
            input.value = '';
            document.getElementById('customBidDropdown').value = '';
            document.getElementById('customBidInput').style.display = 'none';
        }

        function sellPlayer() {
            // CRITICAL: Check basic validation FIRST before locking
            if (selectedTeam === null) {
                alert('Please select a team first!');
                return;
            }
            
            // CRITICAL: Now check hardware lock and set it immediately
            if (buttonsLocked) {
                return;
            }
            buttonsLocked = true; // Set lock immediately to prevent double-clicks
            
            // CRITICAL FIX: Ensure team was selected during THIS bidding round
            // Not just from a previous player
            const teamButtons = document.querySelectorAll('.team-btn');
            let teamWasActuallySelected = false;
            teamButtons.forEach((btn, idx) => {
                if (idx === selectedTeam && btn.classList.contains('selected')) {
                    teamWasActuallySelected = true;
                }
            });
            
            if (!teamWasActuallySelected) {
                buttonsLocked = false; // Unlock if validation fails
                alert('‚ö†Ô∏è No team selected for this player!\n\nPlease click on a team button to place a bid before selling.');
                return;
            }
            
            const team = teams[selectedTeam];
            
            // Check maximum squad size
            if (team.players.length >= maxSquadSize) {
                buttonsLocked = false; // Unlock if validation fails
                alert(`‚ùå Cannot sell! ${team.name} has reached the maximum squad size of ${maxSquadSize} players.`);
                return;
            }
            
            if (currentBidAmount > team.remainingBudget) {
                buttonsLocked = false; // Unlock if validation fails
                alert('‚ö†Ô∏è Team does not have enough budget!\n\nCurrent bid: ‚Çπ' + currentBidAmount + 'L\nTeam budget: ‚Çπ' + team.remainingBudget.toFixed(2) + 'L');
                return;
            }
            
            // CRITICAL FIX #5: Budget corner case - ensure team can complete minimum squad
            const playersNeeded = minSquadSize - team.players.length;
            if (playersNeeded > 1) { // If they need more players after this one
                const minBidPerPlayer = 5; // Minimum bid in lakhs (adjust as needed)
                const budgetNeededForRemainingPlayers = (playersNeeded - 1) * minBidPerPlayer;
                const budgetAfterThisPurchase = team.remainingBudget - currentBidAmount;
                
                if (budgetAfterThisPurchase < budgetNeededForRemainingPlayers) {
                    buttonsLocked = false; // Unlock if validation fails
                    alert(`‚ö†Ô∏è BUDGET WARNING - Squad Completion Risk!\n\n` +
                        `${team.name} needs ${playersNeeded} more players to reach minimum squad size (${minSquadSize}).\n\n` +
                        `If you buy this player for ‚Çπ${currentBidAmount}L:\n` +
                        `‚Ä¢ Remaining budget: ‚Çπ${budgetAfterThisPurchase.toFixed(2)}L\n` +
                        `‚Ä¢ Still need: ${playersNeeded - 1} players\n` +
                        `‚Ä¢ Minimum needed: ‚Çπ${budgetNeededForRemainingPlayers}L (@ ‚Çπ${minBidPerPlayer}L each)\n\n` +
                        `This team may not have enough budget to complete their squad!\n\n` +
                        `Do you want to proceed anyway?`);
                    
                    // Ask for confirmation
                    if (!confirm('Proceed with this risky purchase?')) {
                        return;
                    }
                }
            }
            
            // Now lock the UI buttons after all validation passes
            lockActionButtons();
            
            const player = players[currentPlayerIndex];
            
            // Store transaction for undo
            lastTransaction = {
                playerIndex: currentPlayerIndex,
                teamIndex: selectedTeam,
                player: JSON.parse(JSON.stringify(player)), // Deep copy
                price: currentBidAmount,
                teamRemainingBudget: team.remainingBudget
            };
            
            player.status = 'sold';
            player.soldTo = team.name;
            player.soldPrice = currentBidAmount;
            
            team.remainingBudget -= currentBidAmount;
            team.players.push(player);
            
            // Play sold announcement with hammer sound
            playSoldAnnouncement(player.name, team.name, currentBidAmount);
            
            addToSoldList(player);
            updateStats();
            updateTeamsOverview(); // Update teams display to show new player count
            updateDashboard(); // Update dashboard with new purchase
            updatePlayersList(); // Update players list to show sold status
            saveData();
            
            // Show undo button
            document.getElementById('undoBtn').style.display = 'inline-block';
            
            // Check if team has reached minimum requirement
            if (team.players.length === minSquadSize) {
                setTimeout(() => {
                    alert(`‚úÖ ${team.name} has reached the minimum squad size of ${minSquadSize} players!`);
                }, 3500);
            }
            
            // Check if team has reached maximum
            if (team.players.length === maxSquadSize) {
                setTimeout(() => {
                    alert(`üéØ ${team.name} has reached the maximum squad size of ${maxSquadSize} players! They cannot buy more players.`);
                }, 3500);
            }
            
            // Move to next player after overlay animation
            setTimeout(() => {
                nextPlayer();
                unlockActionButtons(); // Unlock buttons for next player
            }, 3200);
        }

        function unsoldPlayer() {
            // Prevent double-clicks
            if (buttonsLocked) {
                return;
            }
            
            lockActionButtons();
            
            const player = players[currentPlayerIndex];
            player.status = 'unsold_final';
            updateStats();
            updatePlayersList(); // Update players list to show unsold status
            saveData();
            
            setTimeout(() => {
                nextPlayer();
                unlockActionButtons();
            }, 500);
        }

        function skipPlayer() {
            // Prevent double-clicks
            if (buttonsLocked) {
                return;
            }
            
            lockActionButtons();
            
            setTimeout(() => {
                nextPlayer();
                unlockActionButtons();
            }, 300);
        }

        function addToSoldList(player) {
            const list = document.getElementById('soldPlayersList');
            const item = document.createElement('div');
            item.className = 'sold-player';
            
            const playerImageHtml = player.image 
                ? `<img src="${player.image}" class="player-image" alt="${player.name}">`
                : `<div class="player-placeholder">${player.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</div>`;
            
            item.innerHTML = `
                <div class="player-info-wrapper">
                    ${playerImageHtml}
                    <div>
                        <strong>${player.name}</strong> (${player.type})
                    </div>
                </div>
                <div>
                    <strong>${player.soldTo}</strong> - ‚Çπ${player.soldPrice}L
                </div>
            `;
            list.insertBefore(item, list.firstChild);
        }

        function updateStats() {
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('soldPlayers').textContent = players.filter(p => p.status === 'sold').length;
            document.getElementById('unsoldPlayers').textContent = players.filter(p => p.status === 'unsold_final').length;
            document.getElementById('remainingPlayers').textContent = players.filter(p => p.status === 'unsold').length;
        }

        function updateTeamsOverview() {
            const overview = document.getElementById('teamsOverview');
            
            if (!overview) {
                console.error('‚ùå teamsOverview element not found!');
                return;
            }
            
            console.log('üìä Updating Teams Overview:', teams.length, 'teams');
            
            if (teams.length === 0) {
                overview.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üë•</div>
                        <h3 style="margin-bottom: 10px; color: #334155;">No Teams Added Yet</h3>
                        <p>Go to the Setup tab to add teams and start your auction!</p>
                    </div>
                `;
                return;
            }
            
            overview.innerHTML = teams.map((team, index) => {
                console.log(`  Team ${index + 1}: ${team.name} - ${team.players.length} players`);
                const playerCount = team.players.length;
                let squadStatusColor = '#64748b';
                let squadStatusText = 'In Progress';
                
                if (playerCount < minSquadSize) {
                    squadStatusColor = '#ef4444';
                    squadStatusText = `Need ${minSquadSize - playerCount} more`;
                } else if (playerCount >= minSquadSize && playerCount < maxSquadSize) {
                    squadStatusColor = '#10b981';
                    squadStatusText = 'Complete ‚úì';
                } else if (playerCount >= maxSquadSize) {
                    squadStatusColor = '#0f3460';
                    squadStatusText = 'Full Squad ‚úì';
                }
                
                return `
                <div class="team-card">
                    <h3>${team.name}</h3>
                    <div class="team-info">
                        <strong>Total Budget:</strong> 
                        <span>‚Çπ${team.budget}L</span>
                    </div>
                    <div class="team-info">
                        <strong>Spent:</strong> 
                        <span style="color: #ef4444;">‚Çπ${(team.budget - team.remainingBudget).toFixed(2)}L</span>
                    </div>
                    <div class="team-info">
                        <strong>Remaining:</strong> 
                        <span style="color: #10b981;">‚Çπ${team.remainingBudget.toFixed(2)}L</span>
                    </div>
                    <div class="team-info">
                        <strong>Squad Size:</strong> 
                        <span style="color: ${squadStatusColor}; font-weight: 700;">${playerCount}/${maxSquadSize}</span>
                    </div>
                    <div style="margin: 12px 0; padding: 8px; background: ${squadStatusColor}22; border-radius: 8px; border-left: 4px solid ${squadStatusColor};">
                        <small style="color: ${squadStatusColor}; font-weight: 700;">${squadStatusText}</small>
                    </div>
                    <hr style="margin: 15px 0; border: none; border-top: 2px solid #e2e8f0;">
                    ${team.players.map(p => {
                        const playerImageHtml = p.image 
                            ? `<img src="${p.image}" class="player-image" alt="${p.name}" style="width: 40px; height: 40px; margin-right: 10px; vertical-align: middle;">`
                            : `<div class="player-placeholder" style="width: 40px; height: 40px; margin-right: 10px; display: inline-flex; font-size: 16px; vertical-align: middle;">${p.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</div>`;
                        
                        return `
                        <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #e2e8f0;">
                            <div style="display: flex; align-items: center;">
                                ${playerImageHtml}
                                <span style="font-size: 14px;">${p.name} <span style="color: #64748b;">(${p.type})</span></span>
                            </div>
                            <span style="font-weight: 700; color: #10b981; font-size: 14px;">‚Çπ${p.soldPrice}L</span>
                        </div>
                    `}).join('')}
                </div>
            `}).join('');
            
            console.log('‚úÖ Teams overview HTML generated:', overview.innerHTML.length, 'characters');
        }

        function updatePlayersList() {
            const list = document.getElementById('playersList');
            
            if (!list) {
                console.error('‚ùå playersList element not found!');
                return;
            }
            
            console.log('üèÉ Updating Players List:', players.length, 'players');
            
            if (players.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üèÉ</div>
                        <h3 style="margin-bottom: 10px; color: #334155;">No Players Added Yet</h3>
                        <p>Go to the Setup tab to add players or import an Excel file!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = players.map(player => {
                const playerImageHtml = player.image 
                    ? `<img src="${player.image}" class="player-image" alt="${player.name}">`
                    : `<div class="player-placeholder">${player.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</div>`;
                
                return `
                <div class="player-item">
                    <div class="player-info-wrapper">
                        ${playerImageHtml}
                        <div>
                            <strong>${player.name}</strong> (${player.type})
                            <br>Base Price: ‚Çπ${player.basePrice}L
                        </div>
                    </div>
                    <div>
                        ${player.status === 'sold' 
                            ? `<span style="color: green;">SOLD to ${player.soldTo} for ‚Çπ${player.soldPrice}L</span>`
                            : player.status === 'unsold_final'
                            ? `<span style="color: red;">UNSOLD</span>`
                            : `<span style="color: orange;">PENDING</span>`
                        }
                    </div>
                </div>
            `}).join('');
        }

        function saveData() {
            const data = {
                teams: teams,
                players: players,
                timerEnabled: document.getElementById('timerEnabled').checked,
                timerDuration: document.getElementById('timerDuration').value,
                minSquadSize: parseInt(document.getElementById('minSquadSize').value),
                maxSquadSize: parseInt(document.getElementById('maxSquadSize').value),
                setsEnabled: document.getElementById('setsEnabled').checked,
                set1Type: document.getElementById('set1Type').value,
                set2Type: document.getElementById('set2Type').value,
                set3Type: document.getElementById('set3Type').value,
                set4Type: document.getElementById('set4Type').value
            };
            
            const dataString = JSON.stringify(data);
            
            // Check localStorage size (5MB = ~5,000,000 characters)
            if (dataString.length > 4500000) { // Warning at 4.5MB (90% of limit)
                console.warn('‚ö†Ô∏è Storage Warning: Data size is ' + (dataString.length / 1000000).toFixed(2) + 'MB');
                console.warn('Approaching localStorage limit. Consider using smaller/compressed images.');
                
                // Show warning to user once
                if (!sessionStorage.getItem('storageWarningShown')) {
                    alert('‚ö†Ô∏è STORAGE WARNING\n\n' +
                        'Your auction data is getting large (' + (dataString.length / 1000000).toFixed(2) + 'MB).\n\n' +
                        'RECOMMENDATIONS:\n' +
                        '‚Ä¢ Use smaller, compressed JPG images\n' +
                        '‚Ä¢ Reduce image resolution (recommend max 300x300px)\n' +
                        '‚Ä¢ Export data regularly as backup\n\n' +
                        'Browser storage limit: ~5MB\n' +
                        'This warning appears once per session.');
                    sessionStorage.setItem('storageWarningShown', 'true');
                }
            }
            
            try {
                localStorage.setItem('auctionData', dataString);
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    alert('‚ùå STORAGE FULL!\n\n' +
                        'Cannot save data - localStorage is full.\n\n' +
                        'IMMEDIATE ACTIONS NEEDED:\n' +
                        '1. Export your data NOW (use Export buttons)\n' +
                        '2. Remove some player/team images\n' +
                        '3. Use smaller, compressed images\n' +
                        '4. Clear browser cache\n\n' +
                        'Current data size: ' + (dataString.length / 1000000).toFixed(2) + 'MB\n' +
                        'Browser limit: ~5MB');
                    console.error('localStorage quota exceeded:', e);
                } else {
                    console.error('Error saving data:', e);
                    alert('Error saving data: ' + e.message);
                }
            }
        }

        function loadData() {
            const data = localStorage.getItem('auctionData');
            if (data) {
                const parsed = JSON.parse(data);
                teams = parsed.teams || [];
                players = parsed.players || [];
                
                // Load timer settings
                if (parsed.timerEnabled !== undefined) {
                    timerEnabled = parsed.timerEnabled;
                    document.getElementById('timerEnabled').checked = timerEnabled;
                    toggleTimerSettings();
                }
                if (parsed.timerDuration !== undefined) {
                    document.getElementById('timerDuration').value = parsed.timerDuration;
                }
                
                // Load squad size settings
                if (parsed.minSquadSize !== undefined) {
                    minSquadSize = parsed.minSquadSize;
                    document.getElementById('minSquadSize').value = minSquadSize;
                }
                if (parsed.maxSquadSize !== undefined) {
                    maxSquadSize = parsed.maxSquadSize;
                    document.getElementById('maxSquadSize').value = maxSquadSize;
                }
                updateSquadLimits();
                
                // Load set configuration
                if (parsed.setsEnabled !== undefined) {
                    setsEnabled = parsed.setsEnabled;
                    document.getElementById('setsEnabled').checked = setsEnabled;
                    toggleSetsConfiguration();
                }
                if (parsed.set1Type) document.getElementById('set1Type').value = parsed.set1Type;
                if (parsed.set2Type) document.getElementById('set2Type').value = parsed.set2Type;
                if (parsed.set3Type) document.getElementById('set3Type').value = parsed.set3Type;
                if (parsed.set4Type) document.getElementById('set4Type').value = parsed.set4Type;
                
                // Update all displays
                updateTeamsList();
                updateStats();
                updateTeamsOverview(); // Update Teams tab
                updatePlayersList(); // Update Players tab
                updateDashboard(); // Update Dashboard
                
                console.log('‚úÖ Data loaded from localStorage:', teams.length, 'teams,', players.length, 'players');
            }
        }

        function exportData() {
            const data = { teams, players };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'auction_data.json';
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        teams = data.teams || [];
                        players = data.players || [];
                        
                        // Update ALL tabs immediately
                        updateTeamsList();
                        updateStats();
                        updatePlayersList(); // Update Players tab
                        updateTeamsOverview(); // Update Teams tab
                        updateDashboard(); // Update Dashboard
                        saveData();
                        
                        console.log('‚úÖ JSON imported:', teams.length, 'teams,', players.length, 'players');
                        alert(`Data imported successfully!\n${teams.length} teams and ${players.length} players loaded.`);
                    } catch (error) {
                        console.error('‚ùå JSON import error:', error);
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Load data on page load
        loadData();
        
        // DIAGNOSTIC FUNCTION - Force refresh all tabs
        function forceRefreshAllTabs() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîß FORCE REFRESH ALL TABS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Current data:');
            console.log('  Teams:', teams.length, teams);
            console.log('  Players:', players.length, players);
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            
            try {
                console.log('Calling updateTeamsList()...');
                updateTeamsList();
                console.log('‚úÖ updateTeamsList() complete');
                
                console.log('Calling updateStats()...');
                updateStats();
                console.log('‚úÖ updateStats() complete');
                
                console.log('Calling updatePlayersList()...');
                updatePlayersList();
                const playersHTML = document.getElementById('playersList').innerHTML;
                console.log('‚úÖ updatePlayersList() complete - HTML length:', playersHTML.length);
                console.log('   First 200 chars:', playersHTML.substring(0, 200));
                
                console.log('Calling updateTeamsOverview()...');
                updateTeamsOverview();
                const teamsHTML = document.getElementById('teamsOverview').innerHTML;
                console.log('‚úÖ updateTeamsOverview() complete - HTML length:', teamsHTML.length);
                console.log('   First 200 chars:', teamsHTML.substring(0, 200));
                
                console.log('Calling updateDashboard()...');
                updateDashboard();
                const dashHTML = document.getElementById('teamsDashboard').innerHTML;
                console.log('‚úÖ updateDashboard() complete - HTML length:', dashHTML.length);
                console.log('   First 200 chars:', dashHTML.substring(0, 200));
                
                console.log('Calling updatePresentationMode()...');
                updatePresentationMode();
                console.log('‚úÖ updatePresentationMode() complete');
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                alert('‚úÖ All tabs refreshed!\n\nCheck console (F12) for detailed logs.\n\nNow click on Teams, Players, or Dashboard tabs to verify.');
            } catch (error) {
                console.error('‚ùå Error during refresh:', error);
                alert('‚ùå Error refreshing tabs. Check console (F12) for details.');
            }
        }
        
        // CROSS-TAB SYNC: Listen for changes in other tabs/windows
        // This ensures Dashboard and Presentation mode stay synced even if auction is in another tab
        window.addEventListener('storage', function(event) {
            if (event.key === 'auctionData' && event.newValue) {
                try {
                    const updatedData = JSON.parse(event.newValue);
                    
                    // Update global variables
                    teams = updatedData.teams || [];
                    players = updatedData.players || [];
                    
                    // Update all displays
                    updateStats();
                    updateTeamsOverview();
                    updateDashboard();
                    updatePlayersList();
                    updatePresentationMode();
                    
                    console.log('‚úÖ Data synced from another tab');
                } catch (e) {
                    console.error('Error syncing data from storage event:', e);
                }
            }
        });
        
        // CRITICAL FIX #3: Initialize audio context on first user interaction
        // Modern browsers require user gesture before audio can play
        let audioContextInitialized = false;
        document.addEventListener('click', function initAudio() {
            if (!audioContextInitialized) {
                try {
                    const tempContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (tempContext.state === 'suspended') {
                        tempContext.resume().then(() => {
                            console.log('Audio context initialized and ready');
                            audioContextInitialized = true;
                        });
                    }
                } catch (e) {
                    console.log('Audio context initialization skipped:', e);
                }
            }
        }, { once: false });
        
        // CRITICAL FIX #2: Audio test functions for Setup tab
        function testHammerSound() {
            playHammerSound();
            setTimeout(() => {
                alert('‚úÖ Hammer sound test complete!\n\nIf you heard three quick hammer hits, your audio is working correctly.');
            }, 800);
        }
        
        function testTimerAlert() {
            playTimerAlert();
            setTimeout(() => {
                alert('‚úÖ Timer alert test complete!\n\nIf you heard a beep sound, your audio is working correctly.');
            }, 700);
        }
        
        function testVoiceAnnouncement() {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Audio test. Testing, one, two, three.');
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speechSynthesis.speak(utterance);
                
                setTimeout(() => {
                    alert('‚úÖ Voice announcement test complete!\n\nIf you heard "Audio test. Testing, one, two, three," your text-to-speech is working correctly.');
                }, 3000);
            } else {
                alert('‚ùå Text-to-speech not supported in this browser.\n\nThe SOLD announcement voice will not work, but hammer sounds will still play.');
            }
        }
    </script>
</body>
</html>

<!-- ================= FIX BOOTSTRAP (AUTO-GENERATED) ================= -->
<script>
(function () {
  function safe(fn){ try{ fn && fn(); }catch(e){ console.error(e); } }

  function forceRender(){
    safe(window.renderDashboard);
    safe(window.renderTeams);
    safe(window.renderPlayers);
    safe(window.renderPresentation);
  }

  const oldSwitch = window.switchTab;
  window.switchTab = function(tab){
    if(oldSwitch) oldSwitch(tab);
    forceRender();
  };

  document.addEventListener("DOMContentLoaded", function(){
    forceRender();
  });

  // Guard unsoldPlayer to prevent crashes
  if(window.unsoldPlayer){
    const _u = window.unsoldPlayer;
    window.unsoldPlayer = function(){
      if(!window.currentPlayer){ alert("No active player"); return; }
      _u();
      forceRender();
    }
  }
})();
</script>
<!-- ================= END FIX ================= -->
